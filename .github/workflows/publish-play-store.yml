name: Publish to Play Store

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-java

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Decode signing key
        env:
          ENCODED_STRING: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
        run: |
          mkdir -p .sign
          echo $ENCODED_STRING | base64 -d > .sign/release.keystore.jks

      - name: Create keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
        run: |
          echo "keystore=.sign/release.keystore.jks" > .sign/keystore.properties
          echo "keyPassword=$KEY_PASSWORD" >> .sign/keystore.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> .sign/keystore.properties
          echo "keyAlias=$KEY_ALIAS" >> .sign/keystore.properties

      - name: Create Google services file
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p app/src/release
          echo $GOOGLE_SERVICES_JSON | base64 -d > app/src/release/google-services.json

      - name: Create service account key
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        run: |
          echo $SERVICE_ACCOUNT_JSON | base64 -d > .sign/service_account.json

      - name: Set version from GitHub run number
        run: |
          VERSION_CODE=$((1000000 + $GITHUB_RUN_NUMBER))
          VERSION_NAME="1.0.0-build${GITHUB_RUN_NUMBER}"
          sed -i "s/versionCode = [0-9]\+/versionCode = $VERSION_CODE/" app/build.gradle.kts
          sed -i "s/versionName = \".*\"/versionName = \"$VERSION_NAME\"/" app/build.gradle.kts

      - name: Build release AAB
        run: ./gradlew bundleRelease --stacktrace

      - name: Publish to Play Store
        run: ./gradlew publishReleaseBundle

      - name: Notify on success
        if: success()
        run: |
          echo "Successfully published to Play Store!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "Failed to publish to Play Store"
